/**
 * Enhanced Scanner Loader v2.3 - FULLY FIXED VERSION
 * Fixar: timing, contact form display, CTA text, console errors
 */
(function() {
    'use strict';
    
    if (window._scannerLoaderInitialized) {
        console.log('✅ Scanner loader already initialized');
        return;
    }
    window._scannerLoaderInitialized = true;
    
    // Generate unique cache buster
    const CACHE_BUSTER = Date.now();
    
    const SCANNER_CONFIG = {
        baseUrl: 'https://cdn.jsdelivr.net/gh/kaalione/selma-js-assets@latest/',
        version: '2.3',
        cacheBuster: CACHE_BUSTER,
        modules: {
            core: 'enhanced-scanner-core.min.js',
            tracking: 'enhanced-scanner-tracking.min.js', 
            ui: 'enhanced-scanner-ui.min.js',
            resources: 'enhanced-scanner-resources.min.js',
            fix: 'scanner-critical-fix.js'
        },
        loadTimeout: 20000,
        fallbackEnabled: true
    };
    
    window.ScannerLoader = {
        loaded: {},
        loading: {},
        initAttempts: 0,
        maxInitAttempts: 3,
        
        log: function(message, type = 'info') {
            const emoji = {
                info: 'ℹ️',
                success: '✅',
                warning: '⚠️',
                error: '❌',
                loading: '🔄'
            };
            console.log(`${emoji[type] || emoji.info} [Scanner Loader] ${message}`);
        },
        
        loadModule: function(moduleName, callback) {
            if (this.loaded[moduleName]) {
                this.log(`Module ${moduleName} already loaded`, 'success');
                callback && callback();
                return Promise.resolve();
            }
            
            if (this.loading[moduleName]) {
                this.log(`Module ${moduleName} already loading...`, 'info');
                return this.loading[moduleName];
            }
            
            this.log(`Loading module: ${moduleName}`, 'loading');
            
            const script = document.createElement('script');
            script.src = SCANNER_CONFIG.baseUrl + SCANNER_CONFIG.modules[moduleName] + '?v=' + SCANNER_CONFIG.cacheBuster;
            script.async = true;
            script.defer = true;
            
            const promise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    this.log(`Module ${moduleName} loading timeout`, 'warning');
                    reject(new Error(`Module ${moduleName} timeout`));
                }, SCANNER_CONFIG.loadTimeout);
                
                script.onload = () => {
                    clearTimeout(timeout);
                    this.loaded[moduleName] = true;
                    delete this.loading[moduleName];
                    this.log(`Module ${moduleName} loaded successfully`, 'success');
                    callback && callback();
                    resolve();
                };
                
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete this.loading[moduleName];
                    this.log(`Failed to load module: ${moduleName}`, 'error');
                    reject(new Error(`Failed to load module: ${moduleName}`));
                };
            });
            
            this.loading[moduleName] = promise;
            document.head.appendChild(script);
            return promise;
        },
        
        autoLoad: function() {
            this.log('Starting scanner module loading from jsDelivr', 'loading');
            this.log(`Cache buster: ${SCANNER_CONFIG.cacheBuster}`, 'info');
            
            // Load modules in sequence with proper error handling
            return this.loadModule('core')
                .then(() => {
                    // Verify core loaded properly
                    if (!window.EnhancedScanner || typeof window.EnhancedScanner.init !== 'function') {
                        throw new Error('Core module incomplete - EnhancedScanner not found');
                    }
                    this.log('Core module verified', 'success');
                    
                    // Load UI module (critical for modal display)
                    return this.loadModule('ui');
                })
                .then(() => {
                    // Verify UI loaded properly
                    if (!window.ScannerUI || typeof window.ScannerUI.init !== 'function') {
                        throw new Error('UI module incomplete - ScannerUI not found');
                    }
                    this.log('UI module verified', 'success');
                    
                    // Load tracking module (important but not critical)
                    return this.loadModule('tracking').catch(err => {
                        this.log('Tracking module failed, continuing: ' + err.message, 'warning');
                    });
                })
                .then(() => {
                    // Load resources module (optional)
                    return this.loadModule('resources').catch(err => {
                        this.log('Resources module failed, continuing: ' + err.message, 'warning');
                    });
                })
                .then(() => {
                    // Load critical fix LAST (after all other modules)
                    this.log('Loading critical fix module...', 'loading');
                    return this.loadModule('fix').catch(err => {
                        this.log('Fix module failed, continuing: ' + err.message, 'warning');
                    });
                })
                .then(() => {
                    this.log('All scanner modules loaded, initializing...', 'success');
                    // Small delay to ensure all modules are ready
                    setTimeout(() => this.initializeScanner(), 300);
                })
                .catch(error => {
                    this.log('Scanner loading failed: ' + error.message, 'error');
                    this.loadFallback();
                });
        },
        
        initializeScanner: function() {
            if (this.initAttempts >= this.maxInitAttempts) {
                this.log('Max initialization attempts reached', 'error');
                this.loadFallback();
                return;
            }
            
            this.initAttempts++;
            this.log(`Initialization attempt ${this.initAttempts}/${this.maxInitAttempts}`, 'info');
            
            if (window.EnhancedScanner && typeof window.EnhancedScanner.init === 'function') {
                try {
                    window.EnhancedScanner.init();
                    this.log('Scanner initialized successfully!', 'success');
                    
                    // Verify UI is also initialized
                    if (window.ScannerUI && typeof window.ScannerUI.init === 'function') {
                        try {
                            window.ScannerUI.init();
                            this.log('Scanner UI initialized successfully!', 'success');
                        } catch (uiError) {
                            this.log('Scanner UI initialization error: ' + uiError.message, 'warning');
                        }
                    }
                } catch (error) {
                    this.log('Scanner initialization error: ' + error.message, 'error');
                    
                    if (this.initAttempts < this.maxInitAttempts) {
                        this.log('Retrying initialization in 1 second...', 'warning');
                        setTimeout(() => this.initializeScanner(), 1000);
                    } else {
                        this.loadFallback();
                    }
                }
            } else {
                this.log('EnhancedScanner not available, loading fallback', 'warning');
                this.loadFallback();
            }
        },
        
        loadFallback: function() {
            this.log('Loading scanner fallback mode...', 'warning');
            
            window.EnhancedScanner = {
                config: {
                    partnerId: "66f5d0180130eb9ebefb1233",
                    aceUrl: "https://acsbace.com",
                    locale: "sv"
                },
                
                session: {
                    guid: null,
                    domain: null,
                    reportUrl: null
                },
                
                init: function() {
                    console.log('🔧 Scanner fallback mode active');
                    this.findAndEnhanceForms();
                    
                    // Re-check for new forms periodically
                    setInterval(() => this.findAndEnhanceForms(), 3000);
                },
                
                findAndEnhanceForms: function() {
                    const forms = document.querySelectorAll('form');
                    let enhanced = 0;
                    
                    forms.forEach(form => {
                        if (form.getAttribute('data-fallback-enhanced')) return;
                        
                        const urlInput = form.querySelector(
                            'input[type="url"], ' +
                            'input[placeholder*="website"], ' +
                            'input[placeholder*="hemsida"], ' +
                            'input[placeholder*="webbplats"], ' +
                            'input[data-url-field="true"], ' +
                            'input[id*="domain"], ' +
                            'input[id*="url"]'
                        );
                        
                        if (urlInput) {
                            form.setAttribute('data-fallback-enhanced', 'true');
                            
                            // Clone form to remove old event listeners
                            const newForm = form.cloneNode(true);
                            form.parentNode.replaceChild(newForm, form);
                            
                            newForm.addEventListener('submit', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const urlField = newForm.querySelector(
                                    'input[type="url"], ' +
                                    'input[placeholder*="website"], ' +
                                    'input[placeholder*="hemsida"], ' +
                                    'input[placeholder*="webbplats"], ' +
                                    'input[data-url-field="true"], ' +
                                    'input[id*="domain"], ' +
                                    'input[id*="url"]'
                                );
                                
                                const domain = urlField ? urlField.value.trim() : '';
                                
                                if (domain) {
                                    const cleanDomain = domain
                                        .replace(/^https?:\/\//, '')
                                        .replace(/^www\./, '')
                                        .split('/')[0];
                                    
                                    const sessionId = Date.now();
                                    const reportUrl = `${this.config.aceUrl}/?sessionid=${sessionId}&partnerid=${this.config.partnerId}&locale=${this.config.locale}#audit/${cleanDomain}`;
                                    
                                    console.log('🔗 Opening scanner (fallback mode):', reportUrl);
                                    window.open(reportUrl, '_blank');
                                    
                                    // Track in GTM if available
                                    if (window.dataLayer) {
                                        window.dataLayer.push({
                                            event: 'scanner_initiated',
                                            website: cleanDomain,
                                            fallback_mode: true
                                        });
                                    }
                                } else {
                                    alert('Vänligen ange en giltig webbadress');
                                }
                            });
                            
                            enhanced++;
                        }
                    });
                    
                    if (enhanced > 0) {
                        console.log(`✅ Enhanced ${enhanced} form(s) with fallback mode`);
                    }
                }
            };
            
            window.EnhancedScanner.init();
        }
    };
    
    // Initialize when ready
    function initializeLoader() {
        // Check if we're on a page with forms or scan intent
        const hasRelevantContent = 
            document.querySelector('form') || 
            document.querySelector('[data-scan-form="true"]') ||
            document.querySelector('[id*="scan"]') ||
            document.querySelector('[id*="domain"]') ||
            window.location.search.includes('scanner=true') ||
            window.location.pathname.includes('scanner');
        
        if (hasRelevantContent || document.readyState === 'complete') {
            window.ScannerLoader.log('Relevant content found, starting load...', 'info');
            // Small delay to ensure DOM is stable
            setTimeout(() => {
                window.ScannerLoader.autoLoad();
            }, 100);
        } else {
            window.ScannerLoader.log('Waiting for user interaction or timeout...', 'info');
            // Wait for user interaction or timeout
            const events = ['click', 'scroll', 'keydown', 'touchstart'];
            const handler = () => {
                events.forEach(e => document.removeEventListener(e, handler));
                window.ScannerLoader.log('User interaction detected, loading scanner...', 'info');
                window.ScannerLoader.autoLoad();
            };
            
            events.forEach(e => document.addEventListener(e, handler, { once: true }));
            
            // Fallback timer (5 seconds)
            setTimeout(() => {
                events.forEach(e => document.removeEventListener(e, handler));
                window.ScannerLoader.log('Timeout reached, loading scanner...', 'info');
                window.ScannerLoader.autoLoad();
            }, 5000);
        }
    }
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLoader);
    } else {
        setTimeout(initializeLoader, 100);
    }
    
})();
