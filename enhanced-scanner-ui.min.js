/**
 * Enhanced Scanner UI v3.6 - Complete Implementation
 * UI components with minimizable CTA, analysis states, and all required functions
 */
(function() {
    'use strict';
    
    window.ScannerUI = {
        elements: {
            contactModal: null,
            reportModal: null,
            ctaOverlay: null,
            loadingSpinner: null,
            reportIframe: null
        },
        
        config: {
            modalZIndex: 1000000,
            overlayZIndex: 1000003,
            spinnerZIndex: 1000004,
            animationDuration: 300
        },
        
        init: function() {
            console.log("Scanner UI v3.6 initializing...");
            
            if (window._scannerUIInitialized) {
                console.log("Scanner UI already initialized");
                return;
            }
            window._scannerUIInitialized = true;
            
            this.createModals();
            this.setupEventListeners();
            this.setupModalConflictResolution();
            this.injectEnhancedStyles();
            
            console.log("Scanner UI initialized successfully");
        },
        
        // Enhanced styles for v3.6
        injectEnhancedStyles: function() {
            if (document.getElementById('scanner-ui-styles-v36')) return;
            
            const styles = document.createElement('style');
            styles.id = 'scanner-ui-styles-v36';
            styles.textContent = `
                /* Core modal styles */
                .scanner-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: ${this.config.modalZIndex};
                    display: none;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                
                /* Loading spinner */
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .scanner-spinner {
                    width: 40px;
                    height: 40px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #146FF8;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }
                
                /* Minimizable CTA styles */
                #ctaOverlay {
                    transition: all 0.3s ease;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                
                #ctaOverlay.minimized {
                    height: 50px !important;
                    overflow: hidden;
                }
                
                #ctaOverlay.minimized .cta-content {
                    display: none;
                }
                
                #ctaOverlay.minimized .cta-header {
                    margin: 0 !important;
                }
                
                .cta-minimize-btn {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: transparent;
                    border: 2px solid white;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    transition: all 0.2s ease;
                    z-index: 10;
                }
                
                .cta-minimize-btn:hover {
                    background: rgba(255,255,255,0.1);
                }
                
                #ctaOverlay.minimized .cta-minimize-btn {
                    transform: rotate(180deg);
                }
                
                /* Report analyzing state */
                .report-analyzing {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    background: #f0f4f8;
                    border-radius: 8px;
                    margin: 20px;
                }
                
                .report-analyzing-spinner {
                    width: 30px;
                    height: 30px;
                    border: 3px solid #e0e0e0;
                    border-top: 3px solid #146FF8;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 15px;
                }
                
                /* Compliance status styles */
                #complianceImageContainer {
                    flex: 0 0 280px;
                    position: relative;
                    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    overflow: hidden;
                }
                
                #complianceStatusBadge {
                    position: relative;
                    z-index: 2;
                    background: white;
                    padding: 25px 30px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
                    min-width: 160px;
                }
                
                /* Enhanced modal close button */
                .enhanced-close-btn {
                    align-items: center;
                    background-color: rgba(255, 255, 255, 0.9);
                    border-radius: 50%;
                    border: 1px solid #ddd;
                    cursor: pointer;
                    display: flex;
                    height: 36px;
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    justify-content: center;
                    padding: 0;
                    width: 36px;
                    z-index: 1000001;
                    font-size: 24px;
                    line-height: 1;
                    transition: all 0.15s ease;
                }
                
                .enhanced-close-btn:hover {
                    background-color: rgba(255, 255, 255, 1);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                }
                
                /* Mobile responsive */
                @media (max-width: 768px) {
                    #ctaOverlay {
                        bottom: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        border-radius: 10px 10px 0 0 !important;
                    }
                    
                    #ctaOverlay.minimized {
                        height: 45px !important;
                    }
                    
                    .cta-minimize-btn {
                        width: 28px;
                        height: 28px;
                        font-size: 16px;
                    }
                    
                    #complianceImageContainer {
                        display: none;
                    }
                    
                    .contact-content {
                        width: 95% !important;
                        max-width: none !important;
                    }
                    
                    .enhanced-close-btn {
                        width: 32px;
                        height: 32px;
                        font-size: 20px;
                    }
                }
            `;
            
            document.head.appendChild(styles);
        },
        
        // **MISSING FUNCTION 1: createModals**
        createModals: function() {
            this.createContactModal();
            this.createReportModal();
            this.createCTAOverlay();
        },
        
        // Enhanced contact modal creation
        createContactModal: function() {
            if (document.getElementById('contactModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'contactModal';
            modal.className = 'scanner-modal scanner-contact-modal no-close';
            modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000010;';
            
            modal.innerHTML = `
                <div class="contact-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 0; border-radius: 12px; width: 698px; max-width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden;">
                    <div id="reportAnalyzing" class="report-analyzing" style="display: none;">
                        <div class="report-analyzing-spinner"></div>
                        <div>
                            <h3 style="margin: 0; color: #333; font-size: 18px;">Analyserar din rapport...</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Vänligen vänta medan vi granskar resultaten</p>
                        </div>
                    </div>
                    
                    <div id="contactFormContainer" style="display: none;">
                        <div style="display: flex; align-items: stretch; min-height: 400px;">
                            <div id="complianceImageContainer">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3;">
                                    <img id="complianceStatusImage" src="" alt="Compliance Status" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div id="complianceStatusBadge">
                                    <div id="complianceIcon" style="font-size: 56px; margin-bottom: 12px; line-height: 1;"></div>
                                    <div id="complianceText" style="font-size: 20px; font-weight: 700; color: #333; text-transform: uppercase; letter-spacing: 0.5px;"></div>
                                </div>
                            </div>
                            
                            <div style="flex: 1; padding: 30px 40px;">
                                <h2 id="contactModalTitle" style="margin: 0 0 8px 0; color: #1a1a1a; font-size: 24px; font-weight: 700; line-height: 1.3;">Din kostnadsfria tillgänglighetsrapport är klar!</h2>
                                <p id="complianceMessage" style="color: #666; margin-bottom: 12px; font-size: 15px; line-height: 1.5;"></p>
                                <p id="contactModalSubtext" style="color: #666; margin-bottom: 20px; font-size: 14px; line-height: 1.4;"></p>
                                
                                <form id="contactForm" style="display: flex; flex-direction: column;">
                                    <div style="display: flex; gap: 12px; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <label for="contactPhone" style="display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 14px;">Telefonnummer</label>
                                            <input type="tel" id="contactPhone" placeholder="Ange telefonnummer" required style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label for="contactEmail" style="display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 14px;">E-postadress</label>
                                            <input type="email" id="contactEmail" placeholder="namn@mail.com" required style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 18px;">
                                        <label style="display: flex; align-items: flex-start; cursor: pointer; font-size: 12px; color: #666; line-height: 1.4;">
                                            <input type="checkbox" id="consentCheckbox" required style="margin-right: 8px; margin-top: 2px; cursor: pointer;">
                                            <span>Jag godkänner Selma Group AB <a href="https://www.selma.se/allmana-villkor" target="_blank" style="color: #146FF8; text-decoration: none;">Allmänna villkor</a>, enligt vilket Selma Group AB kommer att behandla mina personuppgifter för marknadsföringssyften enligt <a href="https://www.selma.se/integritetspolicy" target="_blank" style="color: #146FF8; text-decoration: none;">Integritetspolicy</a>, i utbyte mot engångsanvändning av vår tillgänglighetsscanner.</span>
                                        </label>
                                    </div>
                                    
                                    <button type="submit" id="submitContact" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #146FF8 0%, #0056d6 100%); color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">Få fullständig rapport →</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            this.elements.contactModal = modal;
            console.log("Contact modal created");
        },
        
        // **MISSING FUNCTION 2: createReportModal**
        createReportModal: function() {
            if (document.getElementById('enhancedModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'enhancedModal';
            modal.className = 'scanner-modal';
            modal.style.cssText = 'background-color: white; border: 1px solid #ccc; display: none; height: 90%; left: 5%; position: fixed; top: 5%; width: 90%; z-index: 1000000; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);';
            
            modal.innerHTML = `
                <button id="enhancedCloseButton" class="enhanced-close-btn">×</button>
                <div id="reportLoadingSpinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none;">
                    <div class="scanner-spinner"></div>
                    <p style="margin-top: 20px; color: #666;">Laddar din rapport...</p>
                </div>
                <iframe id="enhancedIframe" style="border: none; height: 100%; width: 100%;"></iframe>
            `;
            
            document.body.appendChild(modal);
            this.elements.reportModal = modal;
            this.elements.reportIframe = modal.querySelector('#enhancedIframe');
            this.elements.loadingSpinner = modal.querySelector('#reportLoadingSpinner');
            
            console.log("Report modal created");
        },
        
        // **MISSING FUNCTION 3: createCTAOverlay**
        createCTAOverlay: function() {
            if (document.getElementById('ctaOverlay')) return;
            
            const overlay = document.createElement('div');
            overlay.id = 'ctaOverlay';
            overlay.style.cssText = 'display: none; position: absolute; bottom: 20px; left: 20px; right: 20px; background: #0a2460; color: white; padding: 25px 30px; border-radius: 10px; z-index: 1000003; box-shadow: 0 4px 20px rgba(10, 36, 96, 0.3);';
            
            document.body.appendChild(overlay);
            this.elements.ctaOverlay = overlay;
            console.log("CTA overlay created");
        },
        
        // **MISSING FUNCTION 4: showReportModal**
        showReportModal: function(reportUrl) {
            if (!this.elements.reportModal) this.createReportModal();
            
            const modal = this.elements.reportModal;
            const iframe = this.elements.reportIframe;
            const spinner = this.elements.loadingSpinner;
            
            // Show modal
            modal.style.display = "block";
            window._scannerModalActive = true;
            
            // Show loading spinner
            if (spinner) spinner.style.display = 'block';
            if (iframe) iframe.style.display = 'none';
            
            // Load iframe
            if (iframe) {
                iframe.onload = () => {
                    if (spinner) spinner.style.display = 'none';
                    iframe.style.display = 'block';
                    console.log('Report iframe loaded');
                };
                iframe.onerror = () => {
                    if (spinner) spinner.style.display = 'none';
                    console.error('Failed to load report iframe');
                };
                iframe.src = reportUrl;
            }
            
            console.log('Report modal displayed with URL:', reportUrl);
        },
        
        // Show contact modal with analyzing state
        showContactModal: function(isAnalyzing = false, sessionData = null) {
            if (!this.elements.contactModal) this.createContactModal();
            
            const modal = this.elements.contactModal;
            const analyzingDiv = document.getElementById("reportAnalyzing");
            const formContainer = document.getElementById("contactFormContainer");
            
            if (isAnalyzing) {
                modal.style.display = "block";
                if (analyzingDiv) analyzingDiv.style.display = "flex";
                if (formContainer) formContainer.style.display = "none";
                console.log("Showing report analysis in progress...");
            } else {
                if (analyzingDiv) analyzingDiv.style.display = "none";
                if (formContainer) formContainer.style.display = "block";
                
                // Update compliance status if session data provided
                if (sessionData) {
                    this.updateContactModalWithCompliance(sessionData);
                }
                
                modal.style.display = "block";
                
                // Reset form fields
                const phoneField = document.getElementById("contactPhone");
                const emailField = document.getElementById("contactEmail");
                const consentField = document.getElementById("consentCheckbox");
                
                if (phoneField) phoneField.value = "";
                if (emailField) emailField.value = "";
                if (consentField) consentField.checked = false;
                
                // Track display
                if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                    window.ScannerTracking.trackEvent('contact_modal_displayed', {
                        website: sessionData?.domain,
                        timing: 'afterReportAnalysis',
                        compliance_status: sessionData?.complianceStatus,
                        issues_count: sessionData?.issuesCount
                    });
                }
            }
        },
        
        // Update modal with compliance status
        updateContactModalWithCompliance: function(sessionData) {
            const icon = document.getElementById("complianceIcon");
            const text = document.getElementById("complianceText");
            const message = document.getElementById("complianceMessage");
            const image = document.getElementById("complianceStatusImage");
            const title = document.getElementById("contactModalTitle");
            const subtext = document.getElementById("contactModalSubtext");
            
            const status = sessionData.complianceStatus || "non-compliant";
            
            if (status === "compliant") {
                if (icon) {
                    icon.innerHTML = "✓";
                    icon.style.color = "#4CAF50";
                }
                if (text) {
                    text.textContent = "Tillgänglig";
                    text.style.color = "#4CAF50";
                }
                if (message) {
                    message.textContent = "Bra jobbat! Din hemsida uppfyller tillgänglighetskraven.";
                }
                if (subtext) {
                    subtext.textContent = "Få din detaljerade rapport och tips för att bibehålla god tillgänglighet.";
                }
                if (image) {
                    image.src = "https://cdn.prod.website-files.com/677c70d437d84025e9c2d9aa/68c1763c7a6f6a6487f55f61_gated-hero__desktop--pass-new.webp";
                }
            } else {
                if (icon) {
                    icon.innerHTML = "✕";
                    icon.style.color = "#f44336";
                }
                if (text) {
                    text.textContent = "Ej tillgänglig";
                    text.style.color = "#f44336";
                }
                if (message) {
                    message.textContent = `Vi hittade ${sessionData.issuesCount} tillgänglighetsproblem på ${sessionData.domain}.`;
                }
                if (subtext) {
                    subtext.textContent = "Se dina tillgänglighetsresultat och få din kostnadsfria rapport genom att fylla i dina uppgifter nedan.";
                }
                if (image) {
                    image.src = "https://cdn.prod.website-files.com/677c70d437d84025e9c2d9aa/68c1763c283e2db2c05cc10d_gated-hero__desktop--fail-new.webp";
                }
            }
        },
        
        // Start background report loading
        startBackgroundReportLoading: function(reportUrl, onLoadCallback) {
            if (!this.elements.reportModal) this.createReportModal();
            
            const modal = this.elements.reportModal;
            const iframe = this.elements.reportIframe;
            
            modal.style.display = "block";
            modal.style.zIndex = "1000000";
            iframe.style.display = "none";
            
            let spinner = this.elements.loadingSpinner;
            if (spinner) {
                spinner.style.display = "block";
            }
            
            iframe.onload = () => {
                if (spinner) {
                    spinner.style.display = "none";
                }
                iframe.style.display = "block";
                
                if (onLoadCallback && typeof onLoadCallback === 'function') {
                    onLoadCallback();
                }
            };
            
            iframe.src = reportUrl;
            console.log("Started background report loading");
        },
        
        // Get iframe content for analysis
        getIframeContent: function() {
            if (!this.elements.reportIframe) return null;
            
            try {
                const iframe = this.elements.reportIframe;
                if (iframe && iframe.contentWindow) {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if (doc && doc.body) {
                        return doc.body.innerText || doc.body.textContent || "";
                    }
                }
            } catch (e) {
                console.log("Cannot access iframe content (CORS)");
            }
            
            return null;
        },
        
        // Create minimizable CTA content
        createMinimizableCTAContent: function(sessionData) {
            const status = sessionData.complianceStatus || "non-compliant";
            const issuesText = sessionData.issuesCount > 0 ? `Vi hittade ${sessionData.issuesCount} problem. ` : "";
            
            if (status === "compliant") {
                return `
                    <button class="cta-minimize-btn" onclick="window.ScannerUI.toggleCTAMinimize()">▼</button>
                    <h3 class="cta-header" style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: white; padding-right: 40px;">✓ God tillgänglighet - men arbetet fortsätter</h3>
                    <div class="cta-content">
                        <p style="margin: 0 0 20px 0; font-size: 14px; line-height: 1.5; color: white;">Tillgänglighet kräver kontinuerligt underhåll. Vårt verktyg hjälper dig systematiskt upprätthålla och förbättra din status.</p>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <a href="https://www.selma.se/boka-en-tid" target="_blank" style="display: block; background: white; color: #0a2460; padding: 12px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Se vårt systematiska arbetssätt</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">15 min genomgång</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <a href="tel:+46702405725" style="display: block; background: transparent; color: white; padding: 12px 20px; border: 2px solid white; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Ring: 070-240 57 25</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Få handlingsbar rapport</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <button class="cta-minimize-btn" onclick="window.ScannerUI.toggleCTAMinimize()">▼</button>
                    <h3 class="cta-header" style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: white; padding-right: 40px;">⚠ Tillgänglighetsförbättringar behövs</h3>
                    <div class="cta-content">
                        <p style="margin: 0 0 20px 0; font-size: 14px; line-height: 1.5; color: white;">${issuesText}Från 28 juni 2025 gäller EU:s direktiv. Vår lösning kombinerar AI med mänsklig bedömning för kostnadseffektiv efterlevnad.</p>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <a href="https://www.selma.se/boka-en-tid" target="_blank" style="display: block; background: white; color: #0a2460; padding: 12px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Boka konsultation (15 min)</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Vi förenklar ert tillgänglighetsarbete</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <a href="tel:+46702405725" style="display: block; background: transparent; color: white; padding: 12px 20px; border: 2px solid white; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Ring: 070-240 57 25</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Diskutera er situation</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        },
        
        // Show CTA overlay with minimizable functionality
        showCTAOverlay: function(sessionData) {
            if (!window.EnhancedScanner?.config?.enableCTAOverlay) return;
            if (!this.elements.ctaOverlay) this.createCTAOverlay();
            
            const overlay = this.elements.ctaOverlay;
            const modal = this.elements.reportModal;
            
            if (!overlay || !modal || modal.style.display !== "block") return;
            
            const content = this.createMinimizableCTAContent(sessionData || window.EnhancedScanner?.session || {});
            
            overlay.innerHTML = content;
            modal.appendChild(overlay);
            overlay.style.display = "block";
            
            // Make minimize function available globally
            window.ScannerUI.toggleCTAMinimize = this.toggleCTAMinimize.bind(this);
            
            console.log("CTA overlay displayed with compliance status:", sessionData?.complianceStatus);
            
            if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                window.ScannerTracking.trackEvent('cta_overlay_displayed', {
                    website: sessionData?.domain,
                    compliance_status: sessionData?.complianceStatus,
                    issues_count: sessionData?.issuesCount
                });
            }
        },
        
        // Toggle CTA minimize state
        toggleCTAMinimize: function() {
            const overlay = this.elements.ctaOverlay;
            if (overlay) {
                overlay.classList.toggle("minimized");
                const minimized = overlay.classList.contains("minimized");
                
                if (window.EnhancedScanner) {
                    window.EnhancedScanner.session.ctaMinimized = minimized;
                }
                
                if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                    window.ScannerTracking.trackEvent('cta_overlay_toggled', {
                        minimized: minimized,
                        website: window.EnhancedScanner?.session?.domain
                    });
                }
            }
        },
        
        // **MISSING FUNCTION 5: setupEventListeners**
        setupEventListeners: function() {
            // Close button for report modal
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'enhancedCloseButton') {
                    const modal = document.getElementById('enhancedModal');
                    if (modal) {
                        modal.style.display = 'none';
                        window._scannerModalActive = false;
                        
                        // Also hide CTA overlay if it exists
                        const ctaOverlay = document.getElementById('ctaOverlay');
                        if (ctaOverlay) {
                            ctaOverlay.style.display = 'none';
                        }
                        
                        console.log('Report modal closed');
                    }
                }
            });
            
            // ESC key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const reportModal = document.getElementById('enhancedModal');
                    const contactModal = document.getElementById('contactModal');
                    
                    if (reportModal && reportModal.style.display === 'block') {
                        reportModal.style.display = 'none';
                        window._scannerModalActive = false;
                        
                        // Also hide CTA overlay
                        const ctaOverlay = document.getElementById('ctaOverlay');
                        if (ctaOverlay) {
                            ctaOverlay.style.display = 'none';
                        }
                        
                        console.log('Report modal closed with ESC');
                    }
                    
                    if (contactModal && contactModal.style.display === 'block') {
                        contactModal.style.display = 'none';
                        console.log('Contact modal closed with ESC');
                    }
                }
            });
            
            // Click outside modal to close (optional enhancement)
            document.addEventListener('click', (e) => {
                const reportModal = document.getElementById('enhancedModal');
                const contactModal = document.getElementById('contactModal');
                
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                    window._scannerModalActive = false;
                    
                    const ctaOverlay = document.getElementById('ctaOverlay');
                    if (ctaOverlay) {
                        ctaOverlay.style.display = 'none';
                    }
                }
                
                if (e.target === contactModal) {
                    contactModal.style.display = 'none';
                }
            });
            
            console.log('Event listeners set up successfully');
        },
        
        // **MISSING FUNCTION 6: setupModalConflictResolution**
        setupModalConflictResolution: function() {
            // Prevent modal conflicts by tracking active modals
            const originalAlert = window.alert;
            window.alert = function(message) {
                if (window._scannerModalActive) {
                    console.log('Alert suppressed during scanner modal:', message);
                    return;
                }
                return originalAlert.call(this, message);
            };
            
            const originalConfirm = window.confirm;
            window.confirm = function(message) {
                if (window._scannerModalActive) {
                    console.log('Confirm suppressed during scanner modal:', message);
                    return false;
                }
                return originalConfirm.call(this, message);
            };
            
            const originalPrompt = window.prompt;
            window.prompt = function(message, defaultValue) {
                if (window._scannerModalActive) {
                    console.log('Prompt suppressed during scanner modal:', message);
                    return null;
                }
                return originalPrompt.call(this, message, defaultValue);
            };
            
            console.log('Modal conflict resolution set up');
        },
        
        // Utility: Hide all modals
        hideAllModals: function() {
            if (this.elements.reportModal) {
                this.elements.reportModal.style.display = 'none';
            }
            if (this.elements.contactModal) {
                this.elements.contactModal.style.display = 'none';
            }
            if (this.elements.ctaOverlay) {
                this.elements.ctaOverlay.style.display = 'none';
            }
            window._scannerModalActive = false;
            console.log('All modals hidden');
        },
        
        // Utility: Check if any modal is active
        isModalActive: function() {
            return window._scannerModalActive === true;
        },
        
        // Utility: Get current session data
        getSessionData: function() {
            return window.EnhancedScanner?.session || null;
        }
    };
    
    // Auto-initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.ScannerUI.init();
        });
    } else {
        window.ScannerUI.init();
    }
    
    console.log("Scanner UI v3.6 module loaded successfully");
    
})();
