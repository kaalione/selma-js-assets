/**
 * Enhanced Scanner UI v2.1
 * UI components, modals, overlays, and interactive elements
 */
(function() {
    'use strict';
    
    window.ScannerUI = {
        elements: {
            contactModal: null,
            reportModal: null,
            ctaOverlay: null,
            loadingSpinner: null
        },
        
        config: {
            modalZIndex: 1000000,
            overlayZIndex: 1000003,
            spinnerZIndex: 1000004,
            animationDuration: 300
        },
        
        init: function() {
            console.log("Scanner UI v2.1 initializing...");
            
            if (window._scannerUIInitialized) {
                console.log("Scanner UI already initialized");
                return;
            }
            window._scannerUIInitialized = true;
            
            this.createModals();
            this.setupEventListeners();
            this.setupModalConflictResolution();
            
            console.log("Scanner UI initialized successfully");
        },
        
        // Create all required modal elements
        createModals: function() {
            this.createContactModal();
            this.createReportModal();
            this.createCTAOverlay();
            this.injectStyles();
        },
        
        createContactModal: function() {
            if (document.getElementById('contactModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'contactModal';
            modal.className = 'scanner-modal scanner-contact-modal';
            modal.innerHTML = `
                <div class="scanner-modal-backdrop"></div>
                <div class="scanner-modal-content">
                    <div class="scanner-modal-header">
                        <h3>Få din tillgänglighetsrapport</h3>
                        <button type="button" class="scanner-modal-close" aria-label="Stäng">&times;</button>
                    </div>
                    <div class="scanner-modal-body">
                        <p>För att få din fullständiga rapport, vänligen fyll i följande:</p>
                        <form id="contactForm" class="scanner-contact-form">
                            <div class="scanner-form-group">
                                <label for="contactEmail">E-post *</label>
                                <input type="email" id="contactEmail" required placeholder="din@email.se">
                            </div>
                            <div class="scanner-form-group">
                                <label for="contactPhone">Telefonnummer *</label>
                                <input type="tel" id="contactPhone" required placeholder="070-XXX XX XX">
                            </div>
                            <div class="scanner-form-actions">
                                <button type="submit" class="scanner-btn scanner-btn-primary">Fortsätt till rapport</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            this.elements.contactModal = modal;
        },
        
        createReportModal: function() {
            if (document.getElementById('enhancedModal')) return;
            
            const modal = document.createElement('div');
            modal.id = 'enhancedModal';
            modal.className = 'scanner-modal scanner-report-modal';
            modal.innerHTML = `
                <div class="scanner-modal-backdrop"></div>
                <div class="scanner-modal-content scanner-report-content">
                    <button id="enhancedCloseButton" class="scanner-modal-close" aria-label="Stäng">&times;</button>
                    <iframe id="enhancedIframe" class="scanner-report-iframe"></iframe>
                    <div id="loading-spinner" class="scanner-loading-spinner" style="display: none;">
                        <div class="scanner-spinner-content">
                            <div class="scanner-spinner"></div>
                            <p>Skapar din tillgänglighetsrapport...</p>
                            <p class="scanner-version">Enhanced Scanner v2.1</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            this.elements.reportModal = modal;
            this.elements.loadingSpinner = modal.querySelector('#loading-spinner');
        },
        
        createCTAOverlay: function() {
            if (document.getElementById('ctaOverlay')) return;
            
            const overlay = document.createElement('div');
            overlay.id = 'ctaOverlay';
            overlay.className = 'scanner-cta-overlay';
            overlay.innerHTML = `
                <div class="scanner-cta-content">
                    <h3>Behöver du hjälp att implementera?</h3>
                    <p>Våra experter hjälper dig göra din webbplats 100% tillgänglig</p>
                    <div class="scanner-cta-actions">
                        <a href="/kontakt" class="scanner-btn scanner-btn-primary">Boka kostnadsfritt möte</a>
                        <a href="tel:+46702405725" class="scanner-btn scanner-btn-secondary">Ring oss: 070-240 57 25</a>
                    </div>
                </div>
            `;
            
            this.elements.ctaOverlay = overlay;
        },
        
        injectStyles: function() {
            if (document.getElementById('scanner-ui-styles')) return;
            
            const styles = document.createElement('style');
            styles.id = 'scanner-ui-styles';
            styles.textContent = `
                .scanner-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: ${this.config.modalZIndex};
                    display: none;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                
                .scanner-modal-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    backdrop-filter: blur(2px);
                }
                
                .scanner-modal-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow: hidden;
                }
                
                .scanner-contact-modal .scanner-modal-content {
                    width: 400px;
                    max-width: 90vw;
                }
                
                .scanner-report-modal .scanner-modal-content {
                    width: 90vw;
                    height: 90vh;
                    position: relative;
                }
                
                .scanner-modal-header {
                    padding: 20px 24px 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .scanner-modal-header h3 {
                    margin: 0;
                    font-size: 18px;
                    font-weight: 600;
                    color: #1a1a1a;
                }
                
                .scanner-modal-close {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 4px;
                    color: #666;
                    transition: color 0.2s ease;
                    position: absolute;
                    top: 16px;
                    right: 16px;
                    z-index: ${this.config.modalZIndex + 1};
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                }
                
                .scanner-modal-close:hover {
                    color: #333;
                    background-color: rgba(0, 0, 0, 0.05);
                }
                
                .scanner-modal-body {
                    padding: 16px 24px 24px;
                }
                
                .scanner-modal-body p {
                    margin: 0 0 20px;
                    color: #666;
                    line-height: 1.5;
                }
                
                .scanner-form-group {
                    margin-bottom: 16px;
                }
                
                .scanner-form-group label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                    color: #333;
                    font-size: 14px;
                }
                
                .scanner-form-group input {
                    width: 100%;
                    padding: 12px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-size: 14px;
                    transition: border-color 0.2s ease;
                    box-sizing: border-box;
                }
                
                .scanner-form-group input:focus {
                    outline: none;
                    border-color: #146FF8;
                    box-shadow: 0 0 0 2px rgba(20, 111, 248, 0.1);
                }
                
                .scanner-form-actions {
                    text-align: center;
                    margin-top: 24px;
                }
                
                .scanner-btn {
                    display: inline-block;
                    padding: 12px 24px;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 600;
                    text-decoration: none;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    line-height: 1.4;
                }
                
                .scanner-btn-primary {
                    background: #146FF8;
                    color: white;
                }
                
                .scanner-btn-primary:hover {
                    background: #0056CC;
                    transform: translateY(-1px);
                }
                
                .scanner-btn-secondary {
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 1px solid rgba(255, 255, 255, 0.3);
                }
                
                .scanner-btn-secondary:hover {
                    background: rgba(255, 255, 255, 0.3);
                }
                
                .scanner-report-iframe {
                    width: 100%;
                    height: 100%;
                    border: none;
                    display: none;
                }
                
                .scanner-loading-spinner {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                    z-index: ${this.config.spinnerZIndex};
                }
                
                .scanner-spinner-content {
                    text-align: center;
                }
                
                .scanner-spinner {
                    width: 40px;
                    height: 40px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #146FF8;
                    border-radius: 50%;
                    animation: scanner-spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                
                @keyframes scanner-spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .scanner-spinner-content p {
                    margin: 10px 0;
                    color: #666;
                }
                
                .scanner-version {
                    font-size: 12px !important;
                    color: #999 !important;
                }
                
                .scanner-cta-overlay {
                    position: absolute;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #146FF8 0%, #0056CC 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: ${this.config.overlayZIndex};
                    box-shadow: 0 4px 20px rgba(20, 111, 248, 0.3);
                    display: none;
                }
                
                .scanner-cta-content {
                    text-align: center;
                }
                
                .scanner-cta-content h3 {
                    margin: 0 0 10px;
                    font-size: 18px;
                    font-weight: 600;
                }
                
                .scanner-cta-content p {
                    margin: 0 0 15px;
                    font-size: 14px;
                    opacity: 0.9;
                }
                
                .scanner-cta-actions {
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                    flex-wrap: wrap;
                }
                
                @media (max-width: 768px) {
                    .scanner-contact-modal .scanner-modal-content {
                        width: 95vw;
                        margin: 20px;
                    }
                    
                    .scanner-report-modal .scanner-modal-content {
                        width: 95vw;
                        height: 95vh;
                    }
                    
                    .scanner-cta-actions {
                        flex-direction: column;
                    }
                    
                    .scanner-btn {
                        width: 100%;
                        margin-bottom: 8px;
                    }
                }
                
                /* Animations */
                .scanner-modal.scanner-modal-enter {
                    animation: scanner-modal-enter ${this.config.animationDuration}ms ease-out;
                }
                
                .scanner-modal.scanner-modal-exit {
                    animation: scanner-modal-exit ${this.config.animationDuration}ms ease-in;
                }
                
                @keyframes scanner-modal-enter {
                    from {
                        opacity: 0;
                        transform: scale(0.9);
                    }
                    to {
                        opacity: 1;
                        transform: scale(1);
                    }
                }
                
                @keyframes scanner-modal-exit {
                    from {
                        opacity: 1;
                        transform: scale(1);
                    }
                    to {
                        opacity: 0;
                        transform: scale(0.9);
                    }
                }
            `;
            
            document.head.appendChild(styles);
        },
        
        // Event Listeners Setup
        setupEventListeners: function() {
            // Contact form submission
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'contactForm') {
                    this.handleContactSubmit(e);
                }
            });
            
            // Modal close buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('scanner-modal-close') || 
                    e.target.id === 'enhancedCloseButton') {
                    this.hideReportModal();
                }
            });
            
            // Click outside modal to close
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('scanner-modal-backdrop')) {
                    if (e.target.closest('#contactModal')) {
                        this.hideContactModal();
                    } else if (e.target.closest('#enhancedModal')) {
                        this.hideReportModal();
                    }
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.hideContactModal();
                    this.hideReportModal();
                }
            });
        },
        
        // Modal Conflict Resolution
        setupModalConflictResolution: function() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === "attributes" && mutation.attributeName === "style") {
                        this.resolveModalConflicts();
                    }
                });
            });
            
            const originalModal = document.getElementById("modal66f5d0180130eb9ebefb1233");
            const enhancedModal = document.getElementById("enhancedModal");
            
            if (originalModal) observer.observe(originalModal, { attributes: true });
            if (enhancedModal) observer.observe(enhancedModal, { attributes: true });
            
            setInterval(() => this.resolveModalConflicts(), 1000);
        },
        
        resolveModalConflicts: function() {
            const originalModal = document.getElementById("modal66f5d0180130eb9ebefb1233");
            const enhancedModal = document.getElementById("enhancedModal");
            
            if (originalModal && enhancedModal && 
                originalModal.style.display === "block" && 
                enhancedModal.style.display === "block") {
                
                console.warn("Modal conflict detected - closing original");
                originalModal.style.display = "none";
                return true;
            }
            
            return false;
        },
        
        // Contact Modal Methods
        showContactModal: function() {
            if (!this.elements.contactModal) this.createContactModal();
            
            this.elements.contactModal.style.display = 'block';
            this.elements.contactModal.classList.add('scanner-modal-enter');
            
            // Focus first input
            setTimeout(() => {
                const firstInput = this.elements.contactModal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 100);
            
            if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                window.ScannerTracking.trackEvent('contact_modal_displayed', {
                    website: window.EnhancedScanner?.session?.domain,
                    timing: 'scanner_flow'
                });
            }
            
            console.log("Contact modal displayed");
        },
        
        hideContactModal: function() {
            if (!this.elements.contactModal) return;
            
            this.elements.contactModal.classList.add('scanner-modal-exit');
            setTimeout(() => {
                this.elements.contactModal.style.display = 'none';
                this.elements.contactModal.classList.remove('scanner-modal-enter', 'scanner-modal-exit');
            }, this.config.animationDuration);
        },
        
        handleContactSubmit: function(e) {
            e.preventDefault();
            
            const email = document.getElementById('contactEmail')?.value.trim();
            const phone = document.getElementById('contactPhone')?.value.trim();
            
            if (!email || !phone) {
                alert("Både e-post och telefonnummer krävs för att se rapporten");
                return false;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Vänligen ange en giltig e-postadress");
                return false;
            }
            
            // Validate phone format (basic)
            const phoneRegex = /^[\d\s\-\+\(\)]{8,}$/;
            if (!phoneRegex.test(phone)) {
                alert("Vänligen ange ett giltigt telefonnummer");
                return false;
            }
            
            console.log("Contact info collected:", { email, phone });
            
            // Pass to scanner core
            if (window.EnhancedScanner && typeof window.EnhancedScanner.handleContactSubmit === 'function') {
                const success = window.EnhancedScanner.handleContactSubmit(email, phone);
                if (success) {
                    this.hideContactModal();
                    this.showReportModal();
                }
            }
            
            return false;
        },
        
        // Report Modal Methods
        showReportModal: function() {
            if (!this.elements.reportModal) this.createReportModal();
            
            this.resolveModalConflicts();
            
            if (window._scannerModalActive) {
                console.log("Scanner already active");
                return;
            }
            
            window._scannerModalActive = true;
            
            const modal = this.elements.reportModal;
            const iframe = modal.querySelector('#enhancedIframe');
            const spinner = this.elements.loadingSpinner;
            
            modal.style.display = 'block';
            modal.classList.add('scanner-modal-enter');
            iframe.style.display = 'none';
            
            if (spinner) {
                spinner.style.display = 'flex';
            }
            
            // Get report URL from scanner core
            let reportUrl = '';
            if (window.EnhancedScanner && window.EnhancedScanner.session) {
                reportUrl = window.EnhancedScanner.session.reportUrl;
            }
            
            if (!reportUrl) {
                console.error("No report URL available");
                this.showLoadingError();
                return;
            }
            
            // Loading timeout
            const timeout = setTimeout(() => {
                this.showLoadingError();
            }, 15000);
            
            iframe.onload = () => {
                clearTimeout(timeout);
                if (spinner) {
                    spinner.style.display = 'none';
                }
                iframe.style.display = 'block';
                
                // Show CTA overlay after short delay
                setTimeout(() => this.showCTAOverlay(), 2000);
                
                if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                    window.ScannerTracking.trackEvent('accessibility_report_loaded', {
                        website: window.EnhancedScanner?.session?.domain,
                        report_type: 'enhanced_v2.1',
                        session_id: window.EnhancedScanner?.session?.guid,
                        has_contact_info: !!window.EnhancedScanner?.session?.contactInfo?.email
                    });
                }
            };
            
            iframe.onerror = () => {
                clearTimeout(timeout);
                this.showLoadingError();
            };
            
            iframe.src = reportUrl;
            console.log("Report modal displayed with URL:", reportUrl);
        },
        
        hideReportModal: function() {
            if (!this.elements.reportModal) return;
            
            const modal = this.elements.reportModal;
            const iframe = modal.querySelector('#enhancedIframe');
            
            modal.classList.add('scanner-modal-exit');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('scanner-modal-enter', 'scanner-modal-exit');
                
                if (iframe) {
                    iframe.src = 'about:blank';
                }
                
                this.hideCTAOverlay();
            }, this.config.animationDuration);
            
            window._scannerModalActive = false;
            
            // Track incomplete scan if no contact info
            if (window.EnhancedScanner && window.EnhancedScanner.session) {
                const session = window.EnhancedScanner.session;
                if (session.domain && !session.contactInfo.email && session.scanState === 'initiated') {
                    session.scanState = 'closed';
                    if (typeof window.EnhancedScanner.clearWebhookTimers === 'function') {
                        window.EnhancedScanner.clearWebhookTimers();
                    }
                    if (typeof window.EnhancedScanner.sendWebhook === 'function') {
                        window.EnhancedScanner.sendWebhook('scanner_closed_incomplete');
                    }
                }
            }
            
            if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                window.ScannerTracking.trackEvent('report_modal_closed', {
                    website: window.EnhancedScanner?.session?.domain,
                    has_contact_info: !!window.EnhancedScanner?.session?.contactInfo?.email,
                    data_complete: !!(window.EnhancedScanner?.session?.contactInfo?.email && window.EnhancedScanner?.session?.contactInfo?.phone)
                });
            }
        },
        
        showLoadingError: function() {
            if (!this.elements.loadingSpinner) return;
            
            this.elements.loadingSpinner.innerHTML = `
                <div class="scanner-spinner-content">
                    <p style="color: #e74c3c; font-weight: 600;">Vi kunde inte ladda rapporten</p>
                    <p>Vänligen försök igen eller kontakta support</p>
                    <button onclick="window.ScannerUI.hideReportModal()" class="scanner-btn scanner-btn-primary" style="margin-top: 15px;">Stäng</button>
                </div>
            `;
        },
        
        // CTA Overlay Methods
        showCTAOverlay: function() {
            if (!window.EnhancedScanner?.config?.enableCTAOverlay) return;
            if (!this.elements.ctaOverlay) this.createCTAOverlay();
            
            const modal = this.elements.reportModal;
            if (modal && modal.style.display === 'block') {
                const modalContent = modal.querySelector('.scanner-modal-content');
                if (modalContent) {
                    modalContent.appendChild(this.elements.ctaOverlay);
                    this.elements.ctaOverlay.style.display = 'block';
                    
                    if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                        window.ScannerTracking.trackEvent('cta_overlay_displayed', {
                            website: window.EnhancedScanner?.session?.domain,
                            report_id: window.EnhancedScanner?.session?.reportId
                        });
                    }
                    
                    console.log("CTA overlay displayed");
                }
            }
        },
        
        hideCTAOverlay: function() {
            if (this.elements.ctaOverlay) {
                this.elements.ctaOverlay.style.display = 'none';
            }
        },
        
        // Public API Methods
        onReportReady: function(reportId) {
            console.log("Report ready notification received:", reportId);
            
            // Update CTA overlay or other UI elements if needed
            if (this.elements.ctaOverlay && window.EnhancedScanner?.config?.enableCTAOverlay) {
                setTimeout(() => this.showCTAOverlay(), 1000);
            }
        },
        
        // Utility Methods
        showNotification: function(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `scanner-notification scanner-notification-${type}`;
            notification.innerHTML = `
                <div class="scanner-notification-content">
                    <span>${message}</span>
                    <button type="button" class="scanner-notification-close">&times;</button>
                </div>
            `;
            
            // Add notification styles if not present
            if (!document.getElementById('scanner-notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'scanner-notification-styles';
                styles.textContent = `
                    .scanner-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: ${this.config.modalZIndex + 10};
                        max-width: 400px;
                        background: white;
                        border-radius: 6px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        overflow: hidden;
                        animation: scanner-slide-in 0.3s ease-out;
                    }
                    
                    .scanner-notification-info { border-left: 4px solid #146FF8; }
                    .scanner-notification-success { border-left: 4px solid #10B981; }
                    .scanner-notification-warning { border-left: 4px solid #F59E0B; }
                    .scanner-notification-error { border-left: 4px solid #EF4444; }
                    
                    .scanner-notification-content {
                        padding: 16px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .scanner-notification-close {
                        background: none;
                        border: none;
                        font-size: 18px;
                        cursor: pointer;
                        color: #666;
                        margin-left: 12px;
                    }
                    
                    @keyframes scanner-slide-in {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes scanner-slide-out {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after duration
            const autoRemove = setTimeout(() => {
                this.removeNotification(notification);
            }, duration);
            
            // Manual close
            notification.querySelector('.scanner-notification-close').addEventListener('click', () => {
                clearTimeout(autoRemove);
                this.removeNotification(notification);
            });
        },
        
        removeNotification: function(notification) {
            notification.style.animation = 'scanner-slide-out 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    };
    
    // Auto-initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.ScannerUI.init();
        });
    } else {
        window.ScannerUI.init();
    }
    
})();