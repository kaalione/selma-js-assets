/**
 * Enhanced Scanner UI v3.6 - Complete Implementation
 * UI components with minimizable CTA, analysis states, and all required functions
 */
(function () {
    'use strict';

    window.ScannerUI = {
        elements: {
            contactModal: null,
            reportModal: null,
            ctaOverlay: null,
            loadingSpinner: null,
            reportIframe: null
        },

        config: {
            modalZIndex: 1000000,
            overlayZIndex: 1000003,
            spinnerZIndex: 1000004,
            animationDuration: 300
        },

        init: function () {
            console.log("Scanner UI v3.7 initializing...");

            if (window._scannerUIInitialized) {
                console.log("Scanner UI already initialized");
                return;
            }
            window._scannerUIInitialized = true;

            // Inject styles first
            this.injectEnhancedStyles();

            // Create all modals immediately
            this.createModals();

            // Then setup everything else
            this.setupEventListeners();
            //this.setupModalConflictResolution();

            console.log("Scanner UI initialized successfully");
        },

        // Enhanced styles for v3.6
        injectEnhancedStyles: function () {
            if (document.getElementById('scanner-ui-styles-v36')) return;

            const styles = document.createElement('style');
            styles.id = 'scanner-ui-styles-v36';
            styles.textContent = `
                /* Core modal styles */
                .scanner-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: ${this.config.modalZIndex};
                    display: none;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                
                /* Loading spinner */
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .scanner-spinner {
                    width: 40px;
                    height: 40px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #146FF8;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }
                
                /* Minimizable CTA styles */
                #ctaOverlay {
                    transition: all 0.3s ease;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                
                #ctaOverlay.minimized {
                    height: 75px !important;
                    overflow: hidden;
                }
                
                #ctaOverlay.minimized .cta-content {
                    display: none;
                }
                
                #ctaOverlay.minimized .cta-header {
                    margin: 0 !important;
                }
                
                .cta-minimize-btn {
                    position: absolute;
                    top: 25px;
                    right: 10px;
                    background: transparent;
                    border: 2px solid white;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    transition: all 0.2s ease;
                    z-index: 10;
                }
                
                .cta-minimize-btn:hover {
                    background: rgba(255,255,255,0.1);
                }
                
                #ctaOverlay.minimized .cta-minimize-btn {
                    transform: rotate(180deg);
                }
                
                /* Report analyzing state */
                .report-analyzing {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    background: #f0f4f8;
                    border-radius: 8px;
                    margin: 20px;
                }
                
                .report-analyzing-spinner {
                    width: 30px;
                    height: 30px;
                    border: 3px solid #e0e0e0;
                    border-top: 3px solid #146FF8;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 15px;
                }
                
                /* Compliance status styles */
                #complianceImageContainer {
                    flex: 0 0 280px;
                    position: relative;
                    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    overflow: hidden;
                }
                
                #complianceStatusBadge {
                    position: relative;
                    z-index: 2;
                    background: white;
                    padding: 25px 30px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
                    min-width: 160px;
                }

                /* Enhanced modal close button */
                .enhanced-close-btn {
                    align-items: center;
                    background-color: rgba(255, 255, 255, 0.9);
                    border-radius: 50%;
                    border: 1px solid #ddd;
                    cursor: pointer;
                    display: flex;
                    height: 36px;
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    justify-content: center;
                    padding: 0;
                    width: 36px;
                    z-index: 1000016;
                    font-size: 24px;
                    line-height: 1;
                    transition: all 0.15s ease;
                }
                
                .enhanced-close-btn:hover {
                    background-color: rgba(255, 255, 255, 1);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                }
                
                /* Mobile responsive */
                @media (max-width: 768px) {
                    #ctaOverlay {
                        bottom: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        border-radius: 10px 10px 0 0 !important;
                    }
                    
                    #ctaOverlay.minimized {
                        height: 45px !important;
                    }
                    
                    .cta-minimize-btn {
                        width: 28px;
                        height: 28px;
                        font-size: 16px;
                    }
                    
                    #complianceImageContainer {
                        display: none;
                    }
                    
                    .contact-content {
                        width: 100% !important;
                        max-width: none !important;
                        min-width: 250px !important;
                        align-self: start;
                    }

                    #contactFormInnerContainer {
                        padding: 20px !important;
                    }
                    
                    .enhanced-close-btn {
                        width: 32px;
                        height: 32px;
                        font-size: 20px;
                    }

                    #reco--badge-yearsInRowBadge {
                        display: none !important;
                    }

                    #contactModalTitle {
                        font-size: 14px !important;
                    }
                }
            `;

            document.head.appendChild(styles);
        },

        // **MISSING FUNCTION 1: createModals**
        createModals: function () {
            this.createReportModal();
            //this.createContactModal();
            this.createCTAOverlay();
        },

        // Enhanced contact modal creation
        createContactModal: function (sessionData = null) {
            if (document.getElementById('contactModal')) return;

            const modal = document.createElement('div');
            modal.id = 'contactModal';
            modal.className = 'scanner-modal scanner-contact-modal no-close';
            modal.style.cssText = 'display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000010;';

            // Determine results
            const verdict = sessionData?.reportResult?.verdict;

            // Build a categorized report summary from the iframe payload.
            // The iframe schema (see iframe.html) is typically:
            // reportResult.reports = { [groupName]: { ...subReports, verdict: 'good'|'bad'|..., score: number } }
            const reports = sessionData?.reportResult?.reports ?? {};
            const reportSummary = {
                passedReports: {},
                passedReportsList: [],
                failedReports: {},
                failedReportsList: []
            };

            for (const [groupName, groupReport] of Object.entries(reports)) {
                if (!groupReport || typeof groupReport !== 'object') continue;

                const groupVerdict = groupReport.verdict;
                const isPassed = groupVerdict === 'good';

                if (isPassed) {
                    reportSummary.passedReports[groupName] = groupReport;
                    reportSummary.passedReportsList.push(groupName);
                } else {
                    reportSummary.failedReports[groupName] = groupReport;
                    reportSummary.failedReportsList.push(groupName);
                }
            }


            // Build user-friendly Swedish summaries for each failed report type
            const issuesDetails = [];

            const summaryMap = {
                Clickables: {
                    title: 'Problem med knappar och länkar',
                    summary: 'Klickbara element (knappar/länkar) kan sakna korrekt roll, text eller fokus—svårt för användare att navigera.'
                },
                Titles: {
                    title: 'Problem med rubriker',
                    summary: 'Rubrikstruktur är felaktig eller inkonsekvent—försvårar skärmläsning och innehållsförståelse.'
                },
                Orientation: {
                    title: 'Problem med sidorientering',
                    summary: 'Tabb-ordning, skip-länkar eller dolda element kan hindra effektiv navigation.'
                },
                Menus: {
                    title: 'Problem med menyer',
                    summary: 'Navigationsmenyer saknar korrekt semantik eller tillgängliga kontroller.'
                },
                Graphics: {
                    title: 'Problem med bilder och grafik',
                    summary: 'Bilder kan sakna alt-texter eller ha låg kontrast—svårt för användare att tolka innehåll.'
                },
                Forms: {
                    title: 'Problem med formulär',
                    summary: 'Formulärfält saknar etiketter eller obligatorisk markering—försvårar inmatning och validering.'
                },
                Document: {
                    title: 'Problem med dokumentinställningar',
                    summary: 'Sidans grundinställningar (titel, språk, landmärken) kan vara felkonfigurerade.'
                },
                Readability: {
                    title: 'Problem med läsbarhet',
                    summary: 'Textstorlek, bokstavsavstånd eller kontrast kan vara otillräcklig för god läsbarhet.'
                },
                Carousels: {
                    title: 'Problem med karuseller',
                    summary: 'Karusellkomponenter saknar tillgänglig navigering eller live-regioner.'
                },
                Tables: {
                    title: 'Problem med tabeller',
                    summary: 'Tabeller kan sakna rubriker eller vara felstrukturerade vilket försvårar tolkning.'
                },
                General: {
                    title: 'Allmänna problem',
                    summary: 'Generella tillgänglighetsbrister som påverkar användarupplevelsen.'
                }
            };

            for (const key of reportSummary.failedReportsList) {
                const mapped = summaryMap[key];
                if (mapped) {
                    issuesDetails.push({ title: mapped.title, summary: mapped.summary, variant: 'warning' });
                } else {
                    // Fallback: create a generic entry
                    issuesDetails.push({
                        title: `Problem med "${key}"`,
                        summary: 'Det finns identifierade problem som behöver åtgärdas för bättre tillgänglighet.',
                        variant: 'warning'
                    });
                }
            }

            if (issuesDetails.length === 0) {
                issuesDetails.push({
                    title: 'Inga tillgänglighetsproblem hittades',
                    summary: 'Din webbplats klarade våra kontroller utan några identifierade problem.',
                    variant: 'neutral'
                });

            }

            console.log('Generated report summary:', {
                reportResult: sessionData.reportResult,
                summary: reportSummary,
                issues: issuesDetails
            });

            // Persist on sessionData for later UI updates if needed.
            if (sessionData) sessionData.reportSummary = reportSummary;


            modal.innerHTML = `
            <style>
                    /* CSS Variables */
                    #contact-modal * {
                        --color-warning-bg: #FFF3E9;
                        --color-warning-light: #FFD9C9;
                        --color-warning: #E40000;
                        --color-success-bg: #D4F4DD;
                        --color-success-light: #effff4;
                        --color-success: #00A03E;
                        --color-info-bg: #F5F9FF;
                        --color-border: #EEEEEE;
                        --color-white: #FFFFFF;
                        --color-text-muted: rgba(0, 0, 0, 0.5);
                        --spacing-xsmall: 10px;
                        --spacing-small: 15px;
                        --spacing-medium: 20px;
                        --spacing-large: 30px;
                        --border-radius: 8px;
                        --border-radius-small: 4px;
                    }

                    #contact-modal {
                        overflow-y: auto;
                        max-height: 100%;
                    }

                    /* Base Styles */
                    #contact-modal * {
                        box-sizing: border-box;
                        -webkit-font-smoothing: antialiased;
                        -moz-osx-font-smoothing: grayscale;
                        text-rendering: optimizeLegibility;
                    }

                    #modal-root {
                        background-color: #111;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                    }

                    .contact-modal-content {
                        background-color: var(--color-white);
                        width: 90%;
                        max-width: 768px;
                        margin: 50px auto;
                        overflow: hidden;
                        border-radius: var(--border-radius);
                        position: relative;
                        font-family: 'Nunito Sans', sans-serif;
                    }

                    /* Header Styles */
                    #header-wrapper {
                        background-color: var(--color-warning-bg);
                        padding: var(--spacing-large);
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-large);
                    }

                    #header-wrapper.success {
                        background-color: var(--color-success-light);
                    }

                    #header-wrapper .title {
                        margin: 0 0 5px 0;
                        padding: 0;
                        font-size: 18px;
                        font-weight: 400;
                    }

                    #header-wrapper .description {
                        margin: 0;
                        padding: 0;
                        font-size: 12px;
                        line-height: 1.4;
                        opacity: 0.5;
                    }

                    /* Icon Box Styles */
                    .icon-box {
                        margin: 0;
                        padding: 10px;
                        border-radius: var(--border-radius);
                        background-color: var(--color-warning-bg);
                        width: 50px;
                        height: 50px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                    }

                    .icon-box svg {
                        max-width: 100%;
                        aspect-ratio: 1 / 1;
                    }

                    .icon-box.warning {
                        color: var(--color-warning);
                        background-color: var(--color-warning-light);
                    }

                    .icon-box.success {
                        color: var(--color-success);
                        background-color: var(--color-success-bg);
                    }

                    .icon-box.neutral {
                        color: #595959ff;
                        background-color: #eee;
                    }

                    .icon-box.small {
                        width: 40px;
                        height: 40px;
                        padding: 5px;
                    }

                    /* Main Section Styles */
                    #main-section {
                        background-color: var(--color-white);
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 0;
                    }

                    #main-section aside>.inner,
                    #main-section main>.inner {
                        padding: var(--spacing-large);
                    }

                    #main-section h5 {
                        margin: 0 0 var(--spacing-small) 0;
                        font-size: 16px;
                        font-weight: 600;
                    }

                    /* Summary Styles */
                    .summary-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 10px;
                    }

                    .summary-item:last-child {
                        margin-bottom: 0;
                    }

                    .summary-item p {
                        margin: 0;
                        font-size: 14px;
                    }

                    /* Issue Card Styles */
                    .issue-card {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                        align-items: center;
                    }

                    .issue-card:last-child {
                        margin-bottom:0px;
                    }

                    .issue-card-content {
                        flex-grow: 1;
                    }

                    .issue-card-title {
                        font-size: 12px;
                        font-weight: 600;
                        display: block;
                        margin-bottom: 0px;
                    }

                    .issue-card-description {
                        font-size: 11px;
                        margin: 0;
                        opacity: 0.5;
                        line-height: 1.4;
                    }

                    /* Benefits Box Styles */
                    .benefits-box {
                        background-color: var(--color-info-bg);
                        padding: var(--spacing-medium);
                        border-radius: var(--border-radius);
                        margin-bottom: var(--spacing-large);
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .benefits-box h4 {
                        margin: 0 0 var(--spacing-small) 0;
                        font-size: 12px;
                        font-weight: 600;
                    }

                    .benefit-item {
                        display: flex;
                        align-items: flex-start;
                        gap: 20px;
                    }

                    .benefit-item>div:first-child {
                        width: 30px;
                        text-align: center;
                        display: flex;
                        justify-content: center;
                    }

                    .benefit-item svg {
                        margin-top: 0px;
                        flex-shrink: 0;
                    }

                    .benefit-item p {
                        margin: 0;
                        font-size: 12px;
                        line-height: 1.5;
                    }

                    .benefits-header {
                        display: flex;
                        gap: 20px;
                        align-items: center;
                    }

                    .benefits-header svg {
                        width: 30px;
                        color: #5a9ee3;
                    }

                    .benefits-header h4 {
                        margin: 0px;
                        padding: 0px;
                    }

                    /* Form Styles */
                    #contactForm {
                        margin: 0;
                    }

                    #contactForm input[type="email"] {
                        width: 100%;
                        padding: 12px;
                        border: 1px solid var(--color-border);
                        border-radius: var(--border-radius-small);
                        font-size: 14px;
                        margin-bottom: var(--spacing-small);
                        font-family: inherit;
                    }

                    #contactForm button[type="submit"] {
                        width: 100%;
                        padding: 12px 20px;
                        background-color: var(--color-success);
                        color: white;
                        border: none;
                        border-radius: var(--border-radius-small);
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    }

                    #contactForm button[type="submit"]:hover {
                        background-color: #008C35;
                    }

                    /* Footer Styles */
                    #main-section footer {
                        font-size: 10px;
                        opacity: 0.5;
                        padding: var(--spacing-small);
                        display: flex;
                        justify-content: space-between;
                    }

                    /* Border Utilities */
                    .bl {
                        border-left: 1px solid var(--color-border);
                    }

                    .bb {
                        border-bottom: 1px solid var(--color-border);
                    }

                    .bt {
                        border-top: 1px solid var(--color-border);
                    }

                    .br {
                        border-right: 1px solid var(--color-border);
                    }

                    /* Text Utilities */
                    .text-bold {
                        font-weight: 600;
                    }

                    .text-muted {
                        opacity: 0.5;
                    }

                    /* Responsive Design - Tablet */
                    @media (max-width: 768px) {
                        .contact-modal-content {
                            width: 95%;
                            margin: 30px auto;
                        }

                        #header-wrapper {
                            padding: var(--spacing-medium);
                            gap: var(--spacing-medium);
                        }

                        #header-wrapper .title {
                            font-size: 16px;
                        }

                        #main-section aside>.inner,
                        #main-section main>.inner {
                            padding: var(--spacing-medium);
                        }

                        #main-section footer {
                            flex-wrap: wrap;
                            justify-content: center;
                            gap: 8px;
                            text-align: center;
                        }
                    }

                    /* Responsive Design - Mobile */
                    @media (max-width: 600px) {
                        #contact-modal * {
                            --spacing-large: 20px;
                            --spacing-medium: 15px;
                        }

                        #modal-root {
                            overflow-y: auto;
                        }

                        .contact-modal-content {
                            width: 100%;
                            margin: 0;
                            border-radius: 0;
                            min-height: 100vh;
                        }

                        /* Stack grid on mobile */
                        #main-section {
                            grid-template-columns: 1fr;
                        }

                        /* Remove left border on mobile */
                        .bl {
                            border-left: none;
                        }

                        /* Header adjustments */
                        #header-wrapper {
                            padding: var(--spacing-medium);
                            gap: var(--spacing-small);
                            flex-direction: column;
                            text-align: center;
                        }

                        #header-wrapper .title {
                            font-size: 16px;
                        }

                        #header-wrapper .description {
                            font-size: 11px;
                        }

                        /* Icon adjustments */
                        .icon-box {
                            width: 40px;
                            height: 40px;
                            padding: 8px;
                        }

                        .icon-box.small {
                            width: 35px;
                            height: 35px;
                        }

                        /* Content padding */
                        #main-section aside>.inner,
                        #main-section main>.inner {
                            padding: var(--spacing-medium);
                        }

                        #main-section h5 {
                            font-size: 14px;
                        }

                        /* Summary adjustments */
                        .summary-item {
                            gap: 8px;
                        }

                        .summary-item p {
                            font-size: 13px;
                        }

                        /* Issue card adjustments */
                        .issue-card {
                            gap: 8px;
                        }

                        .issue-card .icon-box {
                            width: 40px;
                            height: 40px;
                        }

                        /* Benefits box adjustments */
                        .benefits-box {
                            padding: var(--spacing-small);
                        }

                        .benefit-item {
                            gap: 12px;
                        }

                        .benefit-item p {
                            font-size: 11px;
                        }

                        /* Form adjustments */
                        #contactForm input[type="email"] {
                            padding: 10px;
                            font-size: 13px;
                        }

                        #contactForm button[type="submit"] {
                            padding: 10px 15px;
                            font-size: 13px;
                        }

                        /* Footer adjustments */
                        #main-section footer {
                            font-size: 9px;
                            padding: var(--spacing-xsmall);
                            flex-direction: column;
                            gap: 5px;
                            text-align: center;
                        }

                        #main-section footer div:not(:last-child)::after {
                            content: " •";
                            margin-left: 3px;
                        }
                    }

                    /* Responsive Design - Small Mobile */
                    @media (max-width: 380px) {
                        #header-wrapper .title {
                            font-size: 14px;
                        }

                        #header-wrapper .description {
                            font-size: 10px;
                        }

                        .benefits-box h4 {
                            font-size: 11px;
                        }

                        .benefit-item p {
                            font-size: 10px;
                        }

                        .issue-card-title {
                            font-size: 11px;
                        }

                        .issue-card-description {
                            font-size: 10px;
                        }
                    }
                </style>
            `

            const issuesList = issuesDetails.map(issue => `
                <div class="issue-card">
                    <figure class="icon-box ${issue.variant}">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2" />
                            <path d="M10 6V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            <circle cx="10" cy="13" r="0.5" fill="currentColor" stroke="currentColor" />
                        </svg>
                    </figure>
                    <div class="issue-card-content">
                        <strong class="issue-card-title">${issue.title}</strong>
                        <p class="issue-card-description">${issue.summary}</p>
                    </div>
                </div>
            `);

            const header = verdict === 'good' ?
                `<header id="header-wrapper" class="success">
                    <figure class="icon-box success">
                        <svg width="43" height="39" viewBox="0 0 43 39" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21.5 1.5C10.7304 1.5 2 10.2304 2 21C2 31.7696 10.7304 40.5 21.5 40.5C32.2696 40.5 41 31.7696 41 21C41 10.2304 32.2696 1.5 21.5 1.5Z" stroke="#00A03E" stroke-width="2"/>
                            <path d="M13.5 21.5L19 27L30 15" stroke="#00A03E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </figure>

                    <div>
                        <h3 class="title">Scanningen är klar – ${issuesDetails.length == 0 ? 'Inga' : 'Få'} tillgänglighetsproblem hittades</h3>
                        <p class="description">
                            Din webbplats klarade våra kontroller, men det finns alltid förbättringspotential. Se den fullständiga rapporten för rekommendationer och förbättringsförslag.
                        </p>
                    </div>
                </header>
                ` :
                `<header id="header-wrapper">
                    <figure class="icon-box warning">
                        <svg width="43" height="39" viewBox="0 0 43 39" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M40.4805 31.016L24.4868 3.027C24.138 2.41165 23.6323 1.89982 23.0212 1.54372C22.4101 1.18762 21.7154 1 21.0081 1C20.3008 1 19.6062 1.18762 18.9951 1.54372C18.384 1.89982 17.8782 2.41165 17.5295 3.027L1.53578 31.016C1.18328 31.6265 0.998449 32.3193 1.00001 33.0242C1.00157 33.7292 1.18947 34.4212 1.54467 35.0301C1.89987 35.639 2.40973 36.1432 3.02259 36.4915C3.63544 36.8399 4.3295 37.02 5.03441 37.0137H37.0219C37.7234 37.0129 38.4124 36.8277 39.0196 36.4764C39.6269 36.1252 40.1311 35.6204 40.4815 35.0127C40.832 34.405 41.0164 33.7157 41.0162 33.0142C41.016 32.3127 40.8313 31.6236 40.4805 31.016Z"
                                stroke="#E40000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21.0281 13.0231V21.0199" stroke="#E40000" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M21.0281 29.0168H21.0481" stroke="#E40000" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </figure>

                    <div>
                        <h3 class="title">Scanningen är klar och tillgänglighetsproblem hittades</h3>
                        <p class="description">
                            Vår skanning visar att din webbplats inte är tillgänglig och följer inte de
                            riktlinjer och lagkrav som finns på en tillgänglighetsanpassad användarupplevelse.
                        </p>
                    </div>
                </header>`;


            modal.innerHTML += `
                <div id="contact-modal">
                    <div class="contact-modal-content">

                        <!-- Header Section -->
                        ${header}

                        <!-- Main Content Section -->
                        <section id="main-section">
                            <!-- Left Side: Summary -->
                            <aside class="bb">
                                <div class="inner">
                                    <h5>Sammanfattning</h5>

                                    <!-- Failed Tests -->
                                    <div class="summary-item">
                                        <figure class="icon-box warning small">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="10" cy="10" r="9" stroke="#E40000" stroke-width="2" />
                                                <path d="M10 6V10" stroke="#E40000" stroke-width="2" stroke-linecap="round" />
                                                <circle cx="10" cy="13" r="0.5" fill="#E40000" stroke="#E40000" />
                                            </svg>
                                        </figure>
                                        <p>${reportSummary.failedReportsList.length} underkända tester</p>
                                    </div>

                                    <!-- Passed Tests -->
                                    <div class="summary-item">
                                        <figure class="icon-box success small">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="10" cy="10" r="9" stroke="#00A03E" stroke-width="2" />
                                                <path d="M6 10L9 13L14 7" stroke="#00A03E" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round" />
                                            </svg>
                                        </figure>
                                        <p>${reportSummary.passedReportsList.length}  godkända tester</p>
                                    </div>
                                </div>

                                <!-- Issue Details -->
                                <div class="inner bt">
                                    ${issuesList.slice(0, 3).join('')}
                                </div>
                            </aside>

                            <!-- Right Side: Contact Form -->
                            <main class="bl">
                                <div class="inner">
                                    <!-- Benefits Section -->
                                    <div class="benefits-box">

                                        <div class="benefits-header">
                                            <div>
                                                <svg data-slot="icon" aria-hidden="true" fill="none" stroke-width="1.5"
                                                    stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path
                                                        d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"
                                                        stroke-linecap="round" stroke-linejoin="round"></path>
                                                </svg>
                                            </div>

                                            <div>
                                                <h4>Det här ingår i fullständiga rapporten</h4>
                                            </div>
                                        </div>

                                        <div class="benefit-item">
                                            <div>
                                                <svg width="16" height="16" viewBox="0 0 20 20" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="10" cy="10" r="9" stroke="#00A03E" stroke-width="2" />
                                                    <path d="M6 10L9 13L14 7" stroke="#00A03E" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </div>
                                            <p>Fullständig lista över WCAG-brister</p>
                                        </div>

                                        <div class="benefit-item">
                                            <div>
                                                <svg width="16" height="16" viewBox="0 0 20 20" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="10" cy="10" r="9" stroke="#00A03E" stroke-width="2" />
                                                    <path d="M6 10L9 13L14 7" stroke="#00A03E" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </div>
                                            <p>Prioriterad åtgärdsplan</p>
                                        </div>

                                        <div class="benefit-item">
                                            <div>
                                                <svg width="16" height="16" viewBox="0 0 20 20" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="10" cy="10" r="9" stroke="#00A03E" stroke-width="2" />
                                                    <path d="M6 10L9 13L14 7" stroke="#00A03E" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </div>
                                            <p>Rekommendationer för förbättring</p>
                                        </div>

                                        <div class="benefit-item">
                                            <div>
                                                <svg width="16" height="16" viewBox="0 0 20 20" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="10" cy="10" r="9" stroke="#00A03E" stroke-width="2" />
                                                    <path d="M6 10L9 13L14 7" stroke="#00A03E" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </div>
                                            <p>Gratis rådgivning <strong>(värde 1490 kr)</strong></p>
                                        </div>
                                    </div>

                                    <!-- Contact Form -->
                                    <p class="text-bold" style="font-size: 12px; margin: 0 0 var(--spacing-small) 0;">
                                        Ange din e-post för att gå vidare
                                    </p>

                                    <form id="contactForm"  data-scanner-enhanced="true">
                                        <input type="email" id="contactEmail" name="email" placeholder="E-postadress" autofocus required>

                                        <button type="submit">
                                            Visa Fullständiga Rapport →
                                        </button>
                                    </form>
                                </div>
                                <!-- Footer -->
                                <footer class="bt">
                                    <div>Helt kostnadsfritt</div>
                                    <div>Helt riskfritt</div>
                                    <div>Nöjda kunder hos reco.se</div>
                                </footer>
                            </main>
                        </section>

                    </div>
                </div>
            `;





            // Insert the modal inside the report modal to prevent blocking the entire website
            const reportModalInner = document.getElementById('enhancedModalContent');
            reportModalInner.appendChild(modal);
            this.elements.contactModal = modal;
            console.log("Contact modal created");
        },

        // **MISSING FUNCTION 2: createReportModal**
        createReportModal: function () {
            if (document.getElementById('enhancedModal')) return;

            const modal = document.createElement('div');
            modal.id = 'enhancedModal';
            modal.className = 'scanner-modal';
            modal.style.cssText = 'background-color: white; border: 1px solid #ccc; display: none; height: 90%; left: 5%; position: fixed; top: 5%; width: 90%; z-index: 1000000; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);';

            modal.innerHTML = `
            <div id="enhancedModalContent" style="position: relative; width: 100%; height: 100%;">
                <button id="enhancedCloseButton" class="enhanced-close-btn">×</button>
                <div id="reportLoadingSpinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none;">
                    <div class="scanner-spinner"></div>
                    <p style="margin-top: 20px; color: #666;">Laddar din rapport...</p>
                </div>
                <iframe id="enhancedIframe" style="border: none; height: 100%; width: 100%;"></iframe>
            </div>
            `;

            document.body.appendChild(modal);
            this.elements.reportModal = modal;
            this.elements.reportIframe = modal.querySelector('#enhancedIframe');
            this.elements.loadingSpinner = modal.querySelector('#reportLoadingSpinner');

            console.log("Report modal created");
        },

        // **MISSING FUNCTION 3: createCTAOverlay**
        createCTAOverlay: function () {
            if (document.getElementById('ctaOverlay')) return;

            const overlay = document.createElement('div');
            overlay.id = 'ctaOverlay';
            overlay.style.cssText = 'display: none; position: absolute; bottom: 20px; left: 20px; right: 20px; background: #0a2460; color: white; padding: 25px 30px; border-radius: 10px; z-index: 1000003; box-shadow: 0 4px 20px rgba(10, 36, 96, 0.3);';

            document.body.appendChild(overlay);
            this.elements.ctaOverlay = overlay;
            console.log("CTA overlay created");
        },

        // **MISSING FUNCTION 4: showReportModal**
        showReportModal: function (reportUrl) {
            // Ensure modal exists
            if (!this.elements.reportModal) {
                console.log("Report modal not found, creating it now...");
                this.createReportModal();
            }

            const modal = this.elements.reportModal;
            const iframe = this.elements.reportIframe;
            const spinner = this.elements.loadingSpinner;

            // Safety check
            if (!modal || !iframe) {
                console.error("Failed to create report modal, opening in new tab");
                window.open(reportUrl, '_blank');
                return;
            }

            // Show modal
            modal.style.display = "block";
            window._scannerModalActive = true;

            // Show loading spinner
            if (spinner) spinner.style.display = 'block';
            if (iframe) iframe.style.display = 'none';

            // Load iframe
            iframe.onload = () => {
                if (spinner) spinner.style.display = 'none';
                iframe.style.display = 'block';
                console.log('Report iframe loaded');
            };

            iframe.onerror = () => {
                if (spinner) spinner.style.display = 'none';
                console.error('Failed to load report iframe');
            };

            iframe.src = reportUrl;

            console.log('Report modal displayed with URL:', reportUrl);
        },

        // Show contact modal with analyzing state
        showContactModal: function (isAnalyzing = false, sessionData = null) {


            // Avoid this by checking URL params for bypass ?partner=true
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("partner") === "true") {
                console.log("Partner bypass detected, not showing CTA overlay");
                return;
            }

            if (!this.elements.contactModal) this.createContactModal(sessionData);

            const modal = this.elements.contactModal;
            const analyzingDiv = document.getElementById("reportAnalyzing");
            const formContainer = document.getElementById("contactFormContainer");

            if (isAnalyzing) {
                modal.style.display = "block";
                if (analyzingDiv) analyzingDiv.style.display = "flex";
                if (formContainer) formContainer.style.display = "none";
                console.log("Showing report analysis in progress...");
            } else {
                if (analyzingDiv) analyzingDiv.style.display = "none";
                if (formContainer) formContainer.style.display = "block";

                modal.style.display = "block";

                // Reset form fields
                const phoneField = document.getElementById("contactPhone");
                const emailField = document.getElementById("contactEmail");

                if (phoneField) phoneField.value = "";
                if (emailField) emailField.value = "";

                // Track display
                if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                    window.ScannerTracking.trackEvent('contact_modal_displayed', {
                        website: sessionData?.domain,
                        timing: 'afterReportAnalysis',
                        compliance_status: sessionData?.complianceStatus,
                        issues_count: sessionData?.issuesCount
                    });
                }
            }
        },

        hideContactModal: function () {
            if (this.elements.contactModal) {
                this.elements.contactModal.style.display = "none";
            }
        },

        // New function: Show simple contact modal BEFORE data exists
        showEarlyContactModal: function(sessionData) {
            console.log('Showing early contact modal (no data yet)');
            
            // Partner bypass - do not show modal if ?partner=true
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("partner") === "true") {
                console.log("Partner bypass detected, not showing early contact modal");
                return;
            }
            
            if (!this.elements.reportModal) {
                this.createReportModal();
            }
            
            // Show report modal (empty page in the background)
            this.elements.reportModal.style.display = 'block';
            window._scannerModalActive = true;
            
            // Create simple modal (without compliance data) with theme styling
            const modal = document.createElement('div');
            modal.id = 'earlyContactModal';
            modal.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000015; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; box-shadow: 0 10px 40px rgba(30, 60, 114, 0.15); position: relative; overflow: hidden;">
                    <!-- Hexagon decoration -->
                    <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; opacity: 0.05; pointer-events: none;">
                        <svg viewBox="0 0 100 100" fill="currentColor" style="color: #0a2460;">
                            <polygon points="50,0 93.3,25 93.3,75 50,100 6.7,75 6.7,25"/>
                        </svg>
                    </div>
                    <div style="position: absolute; bottom: -20px; left: -20px; width: 60px; height: 60px; opacity: 0.05; pointer-events: none;">
                        <svg viewBox="0 0 100 100" fill="currentColor" style="color: #0a2460;">
                            <polygon points="50,0 93.3,25 93.3,75 50,100 6.7,75 6.7,25"/>
                        </svg>
                    </div>
                    
                    <h2 style="margin: 0 0 10px 0; font-size: 24px; color: #0a2460;">Din tillgänglighetsrapport är strax klar!</h2>
                    <p style="margin: 0 0 30px 0; color: #666;">Vi scannar <strong>${sessionData.domain}</strong> just nu. Fyll i din kontaktinfo så får du direkt tillgång till resultatet.</p>
                    
                    <form id="earlyContactForm">
                        <input type="email" id="earlyEmail" placeholder="E-postadress" required 
                               style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;">
                        
                        <input type="tel" id="earlyPhone" placeholder="Telefonnummer" required 
                               style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;">
                        
                        <p style="margin: 0 0 20px 0; font-size: 12px; color: #888; text-align: center;">
                            📄 Vi skickar rapporten som PDF. Du får inget spam.
                        </p>
                        
                        <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #0a2460 0%, #1e3c72 100%); color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(10, 36, 96, 0.2);">
                            Se min rapport →
                        </button>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; font-size: 10px; color: #999; flex-wrap: wrap; gap: 10px;">
                            <span>Helt kostnadsfritt</span>
                            <span>Helt riskfritt</span>
                            <span>Nöjda kunder hos reco.se</span>
                        </div>
                    </form>
                    
                    <div id="earlyLoadingState" style="display: none; text-align: center;">
                        <div class="scanner-spinner"></div>
                        <p style="margin-top: 20px; color: #666;">Tack! Vi skapar din rapport...</p>
                    </div>
                </div>
            `;
            
            // Add to report modal
            const reportModalInner = document.getElementById('enhancedModalContent');
            reportModalInner.appendChild(modal);
            
            // Handle form submit
            const form = modal.querySelector('#earlyContactForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const email = document.getElementById('earlyEmail').value;
                const phone = document.getElementById('earlyPhone').value;
                
                // Save contact info
                window.EnhancedScanner.session.contactInfo.email = email;
                window.EnhancedScanner.session.contactInfo.phone = phone;
                
                // Send webhook
                window.EnhancedScanner.sendWebhook('scanner_lead_complete');
                
                // Check if data is ready
                if (window.EnhancedScanner.session.reportLoaded && window.EnhancedScanner.session.reportAnalyzed) {
                    // Data already exists! Show report immediately
                    console.log('Data already loaded, showing report immediately');
                    modal.remove();
                } else {
                    // Data not ready, show loading state
                    console.log('Data not ready, showing loading state');
                    form.style.display = 'none';
                    document.getElementById('earlyLoadingState').style.display = 'block';
                    
                    // Listen for when data becomes ready
                    const checkData = setInterval(() => {
                        if (window.EnhancedScanner.session.reportLoaded) {
                            clearInterval(checkData);
                            modal.remove();
                            console.log('Data loaded, showing report');
                        }
                    }, 500);
                }
            });
            
            this.elements.earlyContactModal = modal;
        },

        // Update modal with compliance status
        updateContactModalWithCompliance: function (sessionData) {
            const icon = document.getElementById("complianceIcon");
            const text = document.getElementById("complianceText");
            const message = document.getElementById("complianceMessage");
            const image = document.getElementById("complianceStatusImage");
            const title = document.getElementById("contactModalTitle");
            const subtext = document.getElementById("contactModalSubtext");

            const status = sessionData.complianceStatus || "non-compliant";

            if (status === "compliant") {
                if (icon) {
                    icon.innerHTML = "✓";
                    icon.style.color = "#4CAF50";
                }
                if (text) {
                    text.textContent = "Tillgänglig";
                    text.style.color = "#4CAF50";
                }
                if (message) {
                    message.textContent = "Vår skanning visar att din webbplats är tillgänglig. Vi är glada att du har valt att göra den mer inkluderande.";
                }
                if (subtext) {
                    subtext.textContent = "För att visa hela rapporten – inklusive beskrivningar och rekommenderade åtgärder – fyll i dina uppgifter nedan.";
                }
                if (image) {
                    image.src = "https://cdn.prod.website-files.com/677c70d437d84025e9c2d9aa/68c1763c7a6f6a6487f55f61_gated-hero__desktop--pass-new.webp";
                }
            } else {
                if (icon) {
                    icon.innerHTML = "✕";
                    icon.style.color = "#f44336";
                }
                if (text) {
                    text.textContent = "Ej tillgänglig";
                    text.style.color = "#f44336";
                }
                if (message) {
                    message.textContent = `Vi har identifierat ${sessionData.issuesCount} tillgänglighetsproblem på ${sessionData.domain}.`;
                }
                if (subtext) {
                    subtext.textContent = "För att visa hela rapporten – inklusive alla fel, beskrivningar och rekommenderade åtgärder – fyll i dina uppgifter nedan.";
                }
                if (image) {
                    image.src = "https://cdn.prod.website-files.com/677c70d437d84025e9c2d9aa/68c1763c283e2db2c05cc10d_gated-hero__desktop--fail-new.webp";
                }
            }
        },

        // Start background report loading
        // Start background report loading - UI HELPER (line ~400 in UI file)
        startBackgroundReportLoading: function (reportUrl, onLoadCallback) {
            if (!this.elements.reportModal) {
                console.log("Creating report modal...");
                this.createReportModal();
            }

            const modal = this.elements.reportModal;
            const iframe = this.elements.reportIframe;

            // ADD THIS SAFETY CHECK:
            if (!modal || !iframe) {
                console.error("Failed to create modal elements, opening in new tab");
                window.open(reportUrl, '_blank');
                return;
            }

            modal.style.display = "block";
            modal.style.zIndex = "1000000";
            window._scannerModalActive = true; // ADD THIS LINE
            iframe.style.display = "none";

            let spinner = this.elements.loadingSpinner;
            if (spinner) {
                spinner.style.display = "block";
            }

            iframe.onload = () => {
                if (spinner) {
                    spinner.style.display = "none";
                }
                iframe.style.display = "block";

                if (onLoadCallback && typeof onLoadCallback === 'function') {
                    onLoadCallback();
                }
            };

            // ADD ERROR HANDLER:
            iframe.onerror = () => {
                console.error("Failed to load report iframe");
                if (spinner) spinner.style.display = "none";
            };

            iframe.src = reportUrl;
            console.log("Started background report loading");
        },

        // Get iframe content for analysis
        getIframeContent: function () {
            if (!this.elements.reportIframe) return null;

            try {
                const iframe = this.elements.reportIframe;
                if (iframe && iframe.contentWindow) {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if (doc && doc.body) {
                        return doc.body.innerText || doc.body.textContent || "";
                    }
                }
            } catch (e) {
                console.log("Cannot access iframe content (CORS)");
            }

            return null;
        },

        // Create minimizable CTA content
        createMinimizableCTAContent: function (sessionData) {
            const status = sessionData.complianceStatus || "non-compliant";
            const issuesText = sessionData.issuesCount > 0 ? `Vi hittade ${sessionData.issuesCount} problem. ` : "";

            if (status === "compliant") {
                return `
                    <button class="cta-minimize-btn" onclick="window.ScannerUI.toggleCTAMinimize()">▼</button>
                    <h3 class="cta-header" style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: white; padding-right: 40px;">✓ God tillgänglighet - men arbetet fortsätter</h3>
                    <div class="cta-content">
                        <p style="margin: 0 0 20px 0; font-size: 14px; line-height: 1.5; color: white;">Tillgänglighet kräver kontinuerligt underhåll. Vårt verktyg hjälper dig systematiskt upprätthålla och förbättra din status.</p>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <a href="https://www.selma.se/boka-en-tid" target="_blank" style="display: block; background: white; color: #0a2460; padding: 12px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Se vårt systematiska arbetssätt</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">15 min genomgång</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <a href="tel:+46702405725" style="display: block; background: transparent; color: white; padding: 12px 20px; border: 2px solid white; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Ring: 070-240 57 25</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Få handlingsbar rapport</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <button class="cta-minimize-btn" onclick="window.ScannerUI.toggleCTAMinimize()">▼</button>
                    <h3 class="cta-header" style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: white; padding-right: 40px;">⚠ Tillgänglighetsförbättringar behövs</h3>
                    <div class="cta-content">
                        <p style="margin: 0 0 20px 0; font-size: 14px; line-height: 1.5; color: white;">${issuesText}Från 28 juni 2025 gäller EU:s direktiv. Vår lösning kombinerar AI med mänsklig bedömning för kostnadseffektiv efterlevnad.</p>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <a href="https://www.selma.se/boka-en-tid" target="_blank" style="display: block; background: white; color: #0a2460; padding: 12px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Boka konsultation (15 min)</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Vi förenklar ert tillgänglighetsarbete</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <a href="tel:+46702405725" style="display: block; background: transparent; color: white; padding: 12px 20px; border: 2px solid white; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; margin-bottom: 5px;">Ring: 070-240 57 25</a>
                                <p style="margin: 0; font-size: 11px; text-align: center; opacity: 0.9; color: white;">Diskutera er situation</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        },

        // Show CTA overlay with minimizable functionality
        showCTAOverlay: function (sessionData) {
            if (!window.EnhancedScanner?.config?.enableCTAOverlay) return;


            if (!this.elements.ctaOverlay) this.createCTAOverlay();

            const overlay = this.elements.ctaOverlay;
            const modal = this.elements.reportModal;

            if (!overlay || !modal || modal.style.display !== "block") return;

            const content = this.createMinimizableCTAContent(sessionData || window.EnhancedScanner?.session || {});

            overlay.innerHTML = content;
            modal.appendChild(overlay);
            overlay.style.display = "block";

            // Make minimize function available globally
            window.ScannerUI.toggleCTAMinimize = this.toggleCTAMinimize.bind(this);

            console.log("CTA overlay displayed with compliance status:", sessionData?.complianceStatus);

            if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                window.ScannerTracking.trackEvent('cta_overlay_displayed', {
                    website: sessionData?.domain,
                    compliance_status: sessionData?.complianceStatus,
                    issues_count: sessionData?.issuesCount
                });
            }
        },

        // Toggle CTA minimize state
        toggleCTAMinimize: function () {
            const overlay = this.elements.ctaOverlay;
            if (overlay) {
                overlay.classList.toggle("minimized");
                const minimized = overlay.classList.contains("minimized");

                if (window.EnhancedScanner) {
                    window.EnhancedScanner.session.ctaMinimized = minimized;
                }

                if (window.ScannerTracking && typeof window.ScannerTracking.trackEvent === 'function') {
                    window.ScannerTracking.trackEvent('cta_overlay_toggled', {
                        minimized: minimized,
                        website: window.EnhancedScanner?.session?.domain
                    });
                }
            }
        },

        // **MISSING FUNCTION 5: setupEventListeners**
        setupEventListeners: function () {
            // Close button for report modal
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'enhancedCloseButton') {
                    if (!confirm("Är du säker på att du vill stänga rapporten?")) {
                        return;
                    }
                    const modal = document.getElementById('enhancedModal');
                    if (modal) {
                        modal.style.display = 'none';
                        window._scannerModalActive = false;

                        // Also hide CTA overlay if it exists
                        const ctaOverlay = document.getElementById('ctaOverlay');
                        if (ctaOverlay) {
                            ctaOverlay.style.display = 'none';
                        }

                        console.log('Report modal closed');
                    }
                }
            });

            // ESC key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const reportModal = document.getElementById('enhancedModal');
                    const contactModal = document.getElementById('contactModal');

                    if (reportModal && reportModal.style.display === 'block') {
                        if (!confirm("Är du säker på att du vill stänga rapporten?")) {
                            return;
                        }


                        reportModal.style.display = 'none';
                        window._scannerModalActive = false;

                        // Also hide CTA overlay
                        const ctaOverlay = document.getElementById('ctaOverlay');
                        if (ctaOverlay) {
                            ctaOverlay.style.display = 'none';
                        }

                        console.log('Report modal closed with ESC');
                    }

                }
            });

            // Click outside modal to close (optional enhancement)
            document.addEventListener('click', (e) => {
                const reportModal = document.getElementById('enhancedModal');
                const contactModal = document.getElementById('contactModal');

                if (e.target === reportModal) {

                    if (!confirm("Är du säker på att du vill stänga rapporten?")) {
                        return;
                    }

                    reportModal.style.display = 'none';
                    window._scannerModalActive = false;

                    const ctaOverlay = document.getElementById('ctaOverlay');
                    if (ctaOverlay) {
                        ctaOverlay.style.display = 'none';
                    }
                }
            });

            console.log('Event listeners set up successfully');
        },

        // **MISSING FUNCTION 6: setupModalConflictResolution**
        setupModalConflictResolution: function () {
            // Prevent modal conflicts by tracking active modals
            const originalAlert = window.alert;
            window.alert = function (message) {
                if (window._scannerModalActive) {
                    console.log('Alert suppressed during scanner modal:', message);
                    return;
                }
                return originalAlert.call(this, message);
            };

            const originalConfirm = window.confirm;
            window.confirm = function (message) {
                if (window._scannerModalActive) {
                    console.log('Confirm suppressed during scanner modal:', message);
                    return false;
                }
                return originalConfirm.call(this, message);
            };

            const originalPrompt = window.prompt;
            window.prompt = function (message, defaultValue) {
                if (window._scannerModalActive) {
                    console.log('Prompt suppressed during scanner modal:', message);
                    return null;
                }
                return originalPrompt.call(this, message, defaultValue);
            };

            console.log('Modal conflict resolution set up');
        },

        // Utility: Hide all modals
        hideAllModals: function () {
            if (this.elements.reportModal) {
                this.elements.reportModal.style.display = 'none';
            }
            if (this.elements.contactModal) {
                this.elements.contactModal.style.display = 'none';
            }
            if (this.elements.ctaOverlay) {
                this.elements.ctaOverlay.style.display = 'none';
            }
            window._scannerModalActive = false;
            console.log('All modals hidden');
        },

        // Utility: Check if any modal is active
        isModalActive: function () {
            return window._scannerModalActive === true;
        },

        // Utility: Get current session data
        getSessionData: function () {
            return window.EnhancedScanner?.session || null;
        }
    };

    // Auto-initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.ScannerUI.init();
        });
    } else {
        window.ScannerUI.init();
    }

    console.log("Scanner UI v3.6 module loaded successfully");

})();